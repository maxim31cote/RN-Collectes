blueprint:
  name: Notification de Collecte RN-Collectes
  description: >
    Envoie une notification personnalisÃ©e pour rappeler les collectes Ã  venir.
    Le message s'adapte automatiquement selon le nombre de jours avant la collecte
    (aujourd'hui, demain, ou dans X jours).
  domain: automation
  source_url: https://github.com/maxim31cote/RN-Collectes/blob/main/blueprints/automation/rn_collectes/notification_collecte.yaml
  
  input:
    collecte_address:
      name: Adresse Ã  surveiller
      description: SÃ©lectionner l'adresse RN-Collectes Ã  surveiller (sÃ©lectionner n'importe quel capteur de cette adresse)
      selector:
        entity:
          filter:
            - integration: rn_collectes
              domain: sensor
    
    notification_time:
      name: Heure de notification
      description: L'heure Ã  laquelle envoyer la notification
      selector:
        time:
    
    days_before:
      name: Nombre de jours avant
      description: Combien de jours avant la collecte envoyer la notification (0 = le jour mÃªme, 1 = la veille, etc.)
      default: 1
      selector:
        number:
          min: 0
          max: 7
          step: 1
          mode: slider
    
    notify_dechets:
      name: Notifier pour les DÃ©chets
      description: Activer les notifications pour la collecte des dÃ©chets
      default: true
      selector:
        boolean:
    
    notify_recuperation:
      name: Notifier pour la RÃ©cupÃ©ration
      description: Activer les notifications pour la collecte de rÃ©cupÃ©ration
      default: true
      selector:
        boolean:
    
    notify_compost:
      name: Notifier pour le Compost
      description: Activer les notifications pour la collecte de compost
      default: true
      selector:
        boolean:
    
    notify_encombrants:
      name: Notifier pour les Encombrants
      description: Activer les notifications pour la collecte d'encombrants
      default: false
      selector:
        boolean:
    
    notify_residus_verts:
      name: Notifier pour les RÃ©sidus verts
      description: Activer les notifications pour la collecte de rÃ©sidus verts
      default: false
      selector:
        boolean:
    
    notify_arbre_noel:
      name: Notifier pour les Arbres de NoÃ«l
      description: Activer les notifications pour la collecte d'arbres de NoÃ«l
      default: false
      selector:
        boolean:
    
    notify_devices:
      name: Appareils de notification
      description: SÃ©lectionner les appareils qui recevront les notifications
      selector:
        device:
          multiple: true
          filter:
            integration: mobile_app

variables:
  collecte_address_var: !input collecte_address
  days_before_var: !input days_before
  notify_dechets_var: !input notify_dechets
  notify_recuperation_var: !input notify_recuperation
  notify_compost_var: !input notify_compost
  notify_encombrants_var: !input notify_encombrants
  notify_residus_verts_var: !input notify_residus_verts
  notify_arbre_noel_var: !input notify_arbre_noel
  
  # Extraire le prÃ©fixe de l'adresse (le numÃ©ro civique)
  address_prefix: >
    {{ collecte_address_var.split('.')[1].split('_')[0] }}
  
  day_text: >
    {% if days_before_var == 0 %}
      aujourd'hui
    {% elif days_before_var == 1 %}
      demain
    {% else %}
      dans {{ days_before_var }} jours
    {% endif %}
  
  collectes_list: >
    {% set ns = namespace(bacs=[], autres=[]) %}
    
    {% if notify_dechets_var %}
      {% for entity in states.sensor %}
        {% if address_prefix in entity.entity_id and 'dechets' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.bacs = ns.bacs + ['DÃ©chets'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_recuperation_var %}
      {% for entity in states.sensor %}
        {% if address_prefix in entity.entity_id and 'recuperation' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.bacs = ns.bacs + ['RÃ©cupÃ©ration'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_compost_var %}
      {% for entity in states.sensor %}
        {% if address_prefix in entity.entity_id and 'compost' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.bacs = ns.bacs + ['Compost'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_encombrants_var %}
      {% for entity in states.sensor %}
        {% if address_prefix in entity.entity_id and 'encombrants' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.autres = ns.autres + ['Encombrants'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_residus_verts_var %}
      {% for entity in states.sensor %}
        {% if address_prefix in entity.entity_id and 'residus_verts' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.autres = ns.autres + ['RÃ©sidus verts'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_arbre_noel_var %}
      {% for entity in states.sensor %}
        {% if address_prefix in entity.entity_id and 'arbre_de_noel' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.autres = ns.autres + ['Arbre de NoÃ«l'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {{ {'bacs': ns.bacs, 'autres': ns.autres} }}
  
  items_text: >
    {% set bacs = collectes_list.bacs %}
    {% set autres = collectes_list.autres %}
    {% set parts = [] %}
    
    {# Formatter les bacs #}
    {% if bacs | length == 1 %}
      {% set parts = parts + ['le bac Ã  ' + bacs[0]] %}
    {% elif bacs | length == 2 %}
      {% set parts = parts + ['le bac Ã  ' + bacs[0] + ' et le bac Ã  ' + bacs[1]] %}
    {% elif bacs | length == 3 %}
      {% set parts = parts + ['le bac Ã  ' + bacs[0] + ', le bac Ã  ' + bacs[1] + ' et le bac Ã  ' + bacs[2]] %}
    {% endif %}
    
    {# Formatter les autres items #}
    {% if autres | length == 1 %}
      {% set parts = parts + ['les ' + autres[0]] %}
    {% elif autres | length == 2 %}
      {% set parts = parts + ['les ' + autres[0] + ' et les ' + autres[1]] %}
    {% elif autres | length == 3 %}
      {% set parts = parts + ['les ' + autres[0] + ', les ' + autres[1] + ' et les ' + autres[2]] %}
    {% endif %}
    
    {# Combiner tout #}
    {% if parts | length == 1 %}
      {{ parts[0] }}
    {% elif parts | length == 2 %}
      {{ parts[0] + ' et ' + parts[1] }}
    {% else %}
      {{ parts | join(', ') }}
    {% endif %}
  
  message: >
    N'oublie pas de mettre {{ items_text }} au chemin pour {{ day_text }} !

trigger:
  - platform: time
    at: !input notification_time

condition:
  - condition: template
    value_template: "{{ collectes_list.bacs | length > 0 or collectes_list.autres | length > 0 }}"

action:
  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}
          data:
            title: "ğŸ—‘ï¸ Rappel de Collecte"
            message: "{{ message }}"
            data:
              notification_icon: mdi:delete-empty
              tag: collecte_reminder
              group: Collectes

mode: single
