blueprint:
  name: Notification de Collecte RN-Collectes
  description: >
    Envoie une notification personnalisÃ©e pour rappeler les collectes Ã  venir.
    Le message s'adapte automatiquement selon le nombre de jours avant la collecte
    (aujourd'hui, demain, ou dans X jours).
  domain: automation
  source_url: https://github.com/maxim31cote/RN-Collectes/blob/main/blueprints/automation/rn_collectes/notification_collecte.yaml
  
  input:
    notification_time:
      name: Heure de notification
      description: L'heure Ã  laquelle envoyer la notification
      selector:
        time:
    
    days_before:
      name: Nombre de jours avant
      description: Combien de jours avant la collecte envoyer la notification (0 = le jour mÃªme, 1 = la veille, etc.)
      default: 1
      selector:
        number:
          min: 0
          max: 7
          step: 1
          mode: slider
    
    notify_dechets:
      name: Notifier pour les DÃ©chets
      description: Activer les notifications pour la collecte des dÃ©chets
      default: true
      selector:
        boolean:
    
    notify_recuperation:
      name: Notifier pour la RÃ©cupÃ©ration
      description: Activer les notifications pour la collecte de rÃ©cupÃ©ration
      default: true
      selector:
        boolean:
    
    notify_compost:
      name: Notifier pour le Compost
      description: Activer les notifications pour la collecte de compost
      default: true
      selector:
        boolean:
    
    notify_encombrants:
      name: Notifier pour les Encombrants
      description: Activer les notifications pour la collecte d'encombrants
      default: false
      selector:
        boolean:
    
    notify_residus_verts:
      name: Notifier pour les RÃ©sidus verts
      description: Activer les notifications pour la collecte de rÃ©sidus verts
      default: false
      selector:
        boolean:
    
    notify_arbre_noel:
      name: Notifier pour les Arbres de NoÃ«l
      description: Activer les notifications pour la collecte d'arbres de NoÃ«l
      default: false
      selector:
        boolean:
    
    notify_devices:
      name: Appareils de notification
      description: SÃ©lectionner les appareils qui recevront les notifications
      selector:
        device:
          multiple: true
          filter:
            integration: mobile_app

variables:
  days_before_var: !input days_before
  notify_dechets_var: !input notify_dechets
  notify_recuperation_var: !input notify_recuperation
  notify_compost_var: !input notify_compost
  notify_encombrants_var: !input notify_encombrants
  notify_residus_verts_var: !input notify_residus_verts
  notify_arbre_noel_var: !input notify_arbre_noel
  
  day_text: >
    {% if days_before_var == 0 %}
      aujourd'hui
    {% elif days_before_var == 1 %}
      demain
    {% else %}
      dans {{ days_before_var }} jours
    {% endif %}
  
  collectes_list: >
    {% set ns = namespace(collectes=[]) %}
    
    {% if notify_dechets_var %}
      {% for entity in states.sensor %}
        {% if 'dechets' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.collectes = ns.collectes + ['DÃ©chets'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_recuperation_var %}
      {% for entity in states.sensor %}
        {% if 'recuperation' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.collectes = ns.collectes + ['RÃ©cupÃ©ration'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_compost_var %}
      {% for entity in states.sensor %}
        {% if 'compost' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.collectes = ns.collectes + ['Compost'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_encombrants_var %}
      {% for entity in states.sensor %}
        {% if 'encombrants' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.collectes = ns.collectes + ['Encombrants'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_residus_verts_var %}
      {% for entity in states.sensor %}
        {% if 'residus_verts' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.collectes = ns.collectes + ['RÃ©sidus verts'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if notify_arbre_noel_var %}
      {% for entity in states.sensor %}
        {% if 'arbre_de_noel' in entity.entity_id and state_attr(entity.entity_id, 'jours_restants') == days_before_var %}
          {% set ns.collectes = ns.collectes + ['Arbre de NoÃ«l'] %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {{ ns.collectes }}
  
  items_text: >
    {% set items = collectes_list %}
    {% if items | length == 1 %}
      {{ items[0] }}
    {% elif items | length == 2 %}
      {{ items[0] }} et {{ items[1] }}
    {% else %}
      {{ items[:-1] | join(', ') }} et {{ items[-1] }}
    {% endif %}
  
  pluriel: "{{ 's' if collectes_list | length > 1 else '' }}"
  
  message: >
    N'oublie pas de mettre le{{ pluriel }} "{{ items_text }}" au chemin pour {{ day_text }} !

trigger:
  - platform: time
    at: !input notification_time

condition:
  - condition: template
    value_template: "{{ collectes_list | length > 0 }}"

action:
  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}
          data:
            title: "ğŸ—‘ï¸ Rappel de Collecte"
            message: "{{ message }}"
            data:
              notification_icon: mdi:delete-empty
              tag: collecte_reminder
              group: Collectes

mode: single
